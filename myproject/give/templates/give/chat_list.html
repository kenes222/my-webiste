{% extends 'give/base.html' %}

{% block content %}
<h1>Chats</h1>
<form id="searchForm" method="get">
    <input type="text" name="q" id="searchInput" placeholder="Search users..." onkeyup="filterChats()">
    <button type="submit" class="btn btn-primary">Search</button>
</form>

{% if chats %}
    <form id="deleteForm" method="post" action="{% url 'delete_chat' %}">
        {% csrf_token %}
        <ul id="chatList">
            {% for chat in chats %}
                {% for participant in chat.participants.all %}
                    {% if participant != request.user %}
                        <li class="chat-item">
                            <input type="checkbox" name="chat_ids" value="{{ chat.id }}" class="chat-checkbox" style="display: none;">
                            <img src="{{ participant.profile.avatar_url }}" alt="avatar" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                            <a href="{% url 'private_chat' chat.id %}">{{ participant.profile.username }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </ul>
        <button type="submit" class="btn btn-danger" style="display: none;" id="submitDeleteButton">Delete Selected</button>
    </form>
    <button id="showDeleteButton" class="btn btn-danger" style="position: fixed; bottom: 10px; right: 10px;">Delete</button>
{% else %}
    <p>You do not have chats</p>
{% endif %}
<a href="{% url 'dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>

<script>
    document.getElementById('showDeleteButton').addEventListener('click', function() {
        var deleteForm = document.getElementById('deleteForm');
        var checkboxes = document.getElementsByClassName('chat-checkbox');
        var submitDeleteButton = document.getElementById('submitDeleteButton');

        for (var i = 0; i < checkboxes.length; i++) {
            checkboxes[i].style.display = 'inline';
        }

        submitDeleteButton.style.display = 'block';
        this.style.display = 'none';
    });

    document.getElementById('deleteForm').addEventListener('submit', function(event) {
        var checkboxes = document.getElementsByClassName('chat-checkbox');
        var selected = [];
        for (var i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) {
                selected.push(checkboxes[i].value);
            }
        }
        console.log('Selected chat IDs:', selected);  // Debug statement
        if (selected.length === 0) {
            event.preventDefault();
            alert('Please select at least one chat to delete.');
        }
    });

    function filterChats() {
        var input, filter, ul, li, a, i, txtValue;
        input = document.getElementById('searchInput');
        filter = input.value.toUpperCase();
        ul = document.getElementById("chatList");
        li = ul.getElementsByTagName('li');

        for (i = 0; i < li.length; i++) {
            a = li[i].getElementsByTagName("a")[0];
            txtValue = a.textContent || a.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                li[i].style.display = "";
            } else {
                li[i].style.display = "none";
            }
        }
    }
</script>
{% endblock %}
