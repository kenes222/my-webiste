{% extends 'give/base.html' %}

{% block content %}
<div class="container">
    <h1>Create Post</h1>
    <form id="post-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group">
            <label for="id_title">Title:</label>
            <input type="text" name="title" class="form-control" id="id_title" required>
        </div>
        <div class="form-group">
            <label for="id_description">Description:</label>
            <textarea name="description" class="form-control" id="id_description" required></textarea>
        </div>
        <div class="form-group">
            <label for="id_category">Category:</label>
            <select name="category" class="form-control" id="id_category">
                <option value="none">Select a category</option>
                {% for category in categories %}
                <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
            </select>
            <input type="text" name="category_new" class="form-control mt-2" placeholder="Or add a new category">
        </div>
        <div class="form-group">
            <label for="id_images">Images:</label>
            <input type="file" name="images" class="form-control-file" id="id_images" multiple>
        </div>
        <div id="uploaded-files" class="mt-3">
            <h5>Uploaded Files:</h5>
            <ul id="file-list"></ul>
        </div>
        <input type="hidden" id="uploaded-file-ids" name="uploaded_file_ids" value="">
        <input type="hidden" id="deleted-file-ids" name="deleted_file_ids" value="">
        <button type="submit" class="btn btn-primary">Create Post</button>
    </form>
</div>

<script>
let uploadedFiles = [];
let deletedFiles = [];

document.getElementById('id_images').addEventListener('change', function(event) {
    let fileList = event.target.files;
    for (let i = 0; i < fileList.length; i++) {
        uploadFile(fileList[i]);
    }
    // Clear the input value to ensure re-uploading the same file works
    event.target.value = '';
});

function uploadFile(file) {
    let formData = new FormData();
    formData.append('file', file);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch("{% url 'upload_file' %}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let li = document.createElement('li');
            li.textContent = file.name;
            li.setAttribute('data-file-id', data.file_id); // Store the file ID
            
            let deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'btn btn-danger btn-sm ml-2';
            deleteButton.onclick = function(event) { deleteFile(event, li) }; // Attach delete function

            li.appendChild(deleteButton);
            document.getElementById('file-list').appendChild(li);
            uploadedFiles.push(data.file_id);
            updateUploadedFileIds();
            updateFileCount();
        } else {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function deleteFile(event, fileElement) {
    event.preventDefault(); // Prevent the form from submitting
    let fileId = fileElement.getAttribute('data-file-id');

    fetch("{% url 'delete_file' %}?file_id=" + fileId, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            uploadedFiles = uploadedFiles.filter(id => id !== parseInt(fileId));
            deletedFiles.push(parseInt(fileId));
            fileElement.remove();
            updateUploadedFileIds();
            updateDeletedFileIds();
            updateFileCount();
        } else {
            console.error('Error:', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function updateUploadedFileIds() {
    document.getElementById('uploaded-file-ids').value = uploadedFiles.join(',');
}

function updateDeletedFileIds() {
    document.getElementById('deleted-file-ids').value = deletedFiles.join(',');
}

function updateFileCount() {
    const fileCount = document.getElementById('file-list').children.length;
}

// Ensure files are included in final form submission
document.getElementById('post-form').addEventListener('submit', function(event) {
    updateUploadedFileIds();
    updateDeletedFileIds();
});
</script>

<style>
/* Additional styling */
.btn-sm {
    font-size: 0.875rem;
    line-height: 1.5;
    border-radius: 0.2rem;
}
.ml-2 {
    margin-left: 0.5rem;
}
</style>
{% endblock %}
